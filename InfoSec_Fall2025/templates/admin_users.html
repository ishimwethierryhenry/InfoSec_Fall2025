<!-- Information Security Fall 2025 Lab - Admin Users/Files Page (Lab 6)
Displays different content based on admin role:
- user_admin: User management interface
- data_admin: File management interface -->

{% extends "base.html" %} 

{% block content %}
<div class="card">
  {% if user.role == 'user_admin' %}
  <!-- USER ADMIN VIEW: User Management -->
  <h3>User Administration</h3>
  <p>Manage user accounts, roles, and permissions.</p>

  <!-- Create User Form -->
  <div class="admin-section">
    <h4>Create New User</h4>
    <form method="post" action="{{ url_for('admin_create_user') }}" class="form">
      <label for="name">Full Name</label>
      <input id="name" name="name" type="text" required placeholder="e.g., John Doe" />
      
      <label for="andrew_id">Andrew ID</label>
      <input id="andrew_id" name="andrew_id" type="text" required placeholder="e.g., jdoe" />
      
      <label for="password">Temporary Password</label>
      <input id="password" name="password" type="password" required />
      
      <label for="role">Role</label>
      <select id="role" name="role" required>
        <option value="basic">Basic User</option>
        <option value="user_admin">User Admin</option>
        <option value="data_admin">Data Admin</option>
      </select>
      
      <button type="submit" class="btn btn-primary">Create User</button>
    </form>
  </div>

  <!-- User List -->
  <div class="admin-section">
    <h4>Existing Users</h4>
    {% if users %}
    <table class="admin-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Andrew ID</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr>
          <td>{{ u.id }}</td>
          <td>
            <!-- Inline rename form -->
            <form method="post" action="{{ url_for('admin_change_username') }}" style="display: inline-flex; gap: 5px;">
              <input type="hidden" name="user_id" value="{{ u.id }}" />
              <input type="text" name="new_name" value="{{ u.name }}" style="width: 150px;" />
              <button type="submit" class="btn-small">Rename</button>
            </form>
          </td>
          <td>{{ u.andrew_id }}</td>
          <td>
            <!-- Inline role assignment -->
            <form method="post" action="{{ url_for('admin_assign_role') }}" style="display: inline-flex; gap: 5px;">
              <input type="hidden" name="user_id" value="{{ u.id }}" />
              <select name="role" style="width: 120px;">
                <option value="basic" {% if u.role == 'basic' %}selected{% endif %}>Basic</option>
                <option value="user_admin" {% if u.role == 'user_admin' %}selected{% endif %}>User Admin</option>
                <option value="data_admin" {% if u.role == 'data_admin' %}selected{% endif %}>Data Admin</option>
              </select>
              <button type="submit" class="btn-small">Update</button>
            </form>
          </td>
          <td>
            <!-- Delete user -->
            <form method="post" action="{{ url_for('admin_delete_user') }}" style="display: inline;">
              <input type="hidden" name="user_id" value="{{ u.id }}" />
              <button type="submit" class="btn btn-danger" onclick="return confirm('Delete user {{ u.andrew_id }}? This will also delete their files and OTP chain.')">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No users found.</p>
    {% endif %}
  </div>

  {% elif user.role == 'data_admin' %}
  <!-- DATA ADMIN VIEW: File Management -->
  <h3>Data Administration</h3>
  <p>Manage all files across all users.</p>

  <!-- Global File List -->
  <div class="admin-section">
    <h4>All Files</h4>
    {% if all_files %}
    <table class="admin-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Filename</th>
          <th>Owner</th>
          <th>Uploaded</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for file in all_files %}
        <tr>
          <td>{{ file.id }}</td>
          <td>{{ file.filename }}</td>
          <td>{{ file.owner_andrew_id }}</td>
          <td>{{ file.upload_timestamp }}</td>
          <td>
            <a href="{{ url_for('admin_download_file', file_id=file.id) }}" class="btn btn-small">Download</a>
            <form method="post" action="{{ url_for('admin_delete_file', file_id=file.id) }}" style="display: inline;">
              <button type="submit" class="btn btn-danger btn-small" onclick="return confirm('Delete file {{ file.filename }}?')">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No files in the system.</p>
    {% endif %}
  </div>

  {% endif %}
</div>
{% endblock %}